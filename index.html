<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="color-scheme" content="dark"/>
<title>Referral Race + Mini Games</title>
<style>
  :root{
    --bg:#0c0c12;--ink:#eef2ff;--muted:#a0a7c9;--edge:rgba(255,255,255,.08);
    --p1:#8b5dff;--p2:#aa74ff;--glow:rgba(153,120,255,.3);--acc:#ffd86a;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;overflow-x:hidden;
    background:radial-gradient(1000px 700px at 50% -10%,#1b1c3f 0%,transparent 60%),
               linear-gradient(180deg,#0b0c1a,#070813);
    color:var(--ink);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .app{max-width:520px;margin:0 auto;min-height:100dvh;display:grid;grid-template-rows:auto 1fr}
  header{position:sticky;top:0;background:linear-gradient(180deg,#10112a,#0d0e23);
    border-bottom:1px solid var(--edge);padding:12px 16px;z-index:20}
  .hrow{display:flex;align-items:center;justify-content:space-between}
  .title{font-weight:900;font-size:18px}
  main{padding:14px 14px 116px}
  .card{background:linear-gradient(180deg,#151533,#10112a);border:1px solid var(--edge);
    border-radius:16px;padding:14px;margin-bottom:12px}
  h2{margin:0 0 8px;font-size:18px}
  h3{margin:0 0 8px;font-size:16px}
  p{margin:0 0 8px;color:#dfe5ff}

  /* Quick actions */
  .qa .row{display:flex;align-items:center;justify-content:space-between;
    padding:12px;border:1px solid var(--edge);border-radius:12px;margin-top:8px}
  .qa .btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;font-weight:900;
    background:var(--acc);color:#2a1a00;box-shadow:0 4px 0 rgba(0,0,0,.12);cursor:pointer}

  /* Iframe modal */
  .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:2000}
  .modalBackdrop.show{display:grid}
  .modalCard{width:min(520px,92vw);border-radius:16px;padding:16px;background:linear-gradient(180deg,#151533,#10112a);
    border:1px solid rgba(255,255,255,.12);box-shadow:0 18px 38px rgba(0,0,0,.35);position:relative}
  .closeX{position:absolute;right:10px;top:10px;background:transparent;border:0;color:#cfd8ff;font-weight:900;
    font-size:18px;cursor:pointer}
  .vidWrap{width:100%;aspect-ratio:16/9;background:#000;border-radius:12px;overflow:hidden}

  /* NAV */
  .iconnav{position:fixed;left:50%;transform:translateX(-50%);bottom:max(8px,env(safe-area-inset-bottom,0));
    width:min(520px,100% - 12px);display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:10px 12px;
    background:rgba(16,17,42,.98);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);
    border-radius:16px;z-index:1000;--hot:#ff4fd8;--hot2:#ff9ae8;--ix:0}
  .iconnav .itab{appearance:none;border:0;background:transparent;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 6px;color:#cdd7ff;font-weight:800;border-radius:14px}
  .iconnav .itab span{font-size:11px}
  .iconnav .ico{width:26px;height:26px;fill:none;stroke:currentColor;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round;transition:transform .25s,color .25s}
  .iconnav .itab.active .ico{transform:translateY(-2px) scale(1.06)} .iconnav .itab.active{color:#fff}
  .iconnav .inkbar{position:absolute;bottom:10px;height:44px;left:12px;right:12px;width:calc((100% - 24px - 8px*3)/4);
    border-radius:16px;background:radial-gradient(90% 140% at 10% 0%,var(--hot) 0%,var(--hot2) 60%,#ffcabf 100%);
    box-shadow:0 12px 26px rgba(255,79,216,.35), inset 0 -2px 6px rgba(0,0,0,.18);
    transform:translateX(calc(var(--ix) * (100% + 8px)));transition:transform .28s cubic-bezier(.22,.9,.24,1)}

  /* SOUND */
  .soundBtn{position:fixed;right:12px;bottom:calc(72px + env(safe-area-inset-bottom,0));background:rgba(255,255,255,.95);
    color:#111;border:1px solid rgba(0,0,0,.08);border-radius:14px;padding:10px 12px;display:none;gap:8px;align-items:center;font-weight:900;z-index:1100;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .soundBtn.show{display:inline-flex} .soundBtn.active{background:linear-gradient(90deg,#ffd86a,#ffc24d)}
  .soundBtn .ic{width:22px;height:22px;fill:none;stroke:currentColor;stroke-width:1.8}

  /* RANKS (podium + list) */
  .rr{--ink:#2b2350;--gold:#ffcf5a;--silver:#dbe6ff;--bronze:#ffd9b3}
  .rr .controls{display:grid;grid-template-columns:1fr 1fr auto auto;gap:8px}
  .rr .select,.rr .wbtn{appearance:none;border:0;border-radius:10px;padding:9px 10px;font-weight:800}
  .rr .select{background:#ffffffbf;color:#2d1b55}
  .rr .wbtn{background:#ffd86a;color:#3a2400;box-shadow:0 4px 0 rgba(0,0,0,.12);cursor:pointer}
  .rr .wbtn:active{transform:translateY(1px);box-shadow:0 2px 0 rgba(0,0,0,.12)}
  .rr .podiumCard{margin-top:12px;border-radius:22px;padding:16px 12px 12px;background:linear-gradient(180deg,#f0e6ff,#f9f1ff);border:1px solid rgba(255,255,255,.55);color:var(--ink);box-shadow:0 24px 60px rgba(36,18,66,.35)}
  .rr .podium{display:grid;grid-template-columns:1fr 1.2fr 1fr;gap:10px;align-items:end}
  .rr .step{position:relative;border-radius:16px 16px 10px 10px;background:linear-gradient(180deg,#ffffff,#f0ecff);padding:10px 8px 12px;border:1px solid rgba(44,26,74,.12);box-shadow:inset 0 -12px 18px rgba(100,70,180,.10),0 8px 18px rgba(0,0,0,.10);display:grid;place-items:center;min-height:86px}
  .rr .s1{min-height:120px}.rr .s2{min-height:100px}.rr .s3{min-height:96px}
  .rr .trophy{position:absolute;top:-12px;left:10px;width:34px;height:34px;border-radius:50%;display:grid;place-items:center;font-weight:900;border:2px solid rgba(0,0,0,.06);box-shadow:0 6px 14px rgba(0,0,0,.18)}
  .rr .t1{background:radial-gradient(circle at 35% 30%,#fff,var(--gold) 65%);color:#5a4300}
  .rr .t2{background:radial-gradient(circle at 35% 30%,#fff,var(--silver) 65%);color:#1d2945}
  .rr .t3{background:radial-gradient(circle at 35% 30%,#fff,var(--bronze) 65%);color:#4a2c12}
  .rr .av{position:absolute;top:-64px;left:50%;transform:translateX(-50%);width:76px;height:76px;border-radius:50%;border:4px solid #fff;box-shadow:0 10px 22px rgba(0,0,0,.25);background:#fff center/cover no-repeat}
  .rr .name{margin-top:14px;font-weight:900;color:#32245c;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .rr .scoreMini{color:#6b5d9c;font-size:12px;margin-top:2px}
  .rr .list{margin-top:12px;display:grid;gap:8px}
  .rr .row{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.75));border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px;color:#2b2350}
  .rr .rk{display:grid;place-items:center;width:38px;height:38px;border-radius:12px;font-weight:900;background:#f0ecff;border:1px solid rgba(0,0,0,.06)}
  .rr .face{width:38px;height:38px;border-radius:50%;background:#eee center/cover no-repeat;border:2px solid #fff;margin-right:8px}
  .rr .uname{font-weight:800}
  .rr .val{font-weight:900;color:#5b4bb4}
  .rr .left{display:flex;align-items:center;gap:8px}
  .rr .search{margin-top:12px;display:grid;grid-template-columns:1fr auto;gap:8px}
  .rr .input{border-radius:12px;border:1px solid var(--edge);background:#0f1030;color:#eff3ff;padding:10px 12px}
  .rr .go{appearance:none;border:0;border-radius:12px;padding:10px 12px;background:#ffd86a;color:#3a2400;font-weight:900;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,.12)}
  .rr .go:active{transform:translateY(1px);box-shadow:0 2px 0 rgba(0,0,0,.12)}
  .rr .result{margin-top:8px;background:rgba(255,255,255,.92);border:1px solid rgba(0,0,0,.08);color:#2b2350;border-radius:12px;padding:10px 12px;font-weight:700;display:none}

  /* Community (previous style) */
  .comm .sharebar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .comm .sharebtn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer;background:#ffd86a;color:#2a1a00;box-shadow:0 4px 0 rgba(0,0,0,.12)}
  .comm .list{display:grid;gap:14px;margin-top:12px}
  .comm .item{background:linear-gradient(180deg,#5a34dd,#4a2bc7);border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:16px;color:#fff;display:flex;align-items:center;justify-content:space-between}
  .comm .left{display:flex;align-items:center;gap:12px}
  .comm .bubble{width:44px;height:44px;border-radius:12px;background:#fff;display:grid;place-items:center}
  .comm .sub{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:#fff;color:#2a1a00;font-weight:900;cursor:pointer}

  /* MINI GAME */
  .mg-tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
  .mg-tabs button{appearance:none;border:1px solid var(--edge);background:#15153a;color:#eaf0ff;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
  .mg-tabs button.active{background:linear-gradient(180deg,var(--p2),var(--p1));box-shadow:0 6px 18px var(--glow)}
  .mg-wrap{border:1px solid var(--edge);border-radius:16px;overflow:hidden;background:linear-gradient(180deg,#0f1030,#0b0c26)}
  .mg-head{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #0a0e28}
  .mg-head .title{font-weight:900} .mg-head .ctrls{display:flex;gap:8px}
  .mg-btn{appearance:none;border:0;border-radius:10px;background:#ffd86a;color:#361e00;font-weight:900;padding:8px 12px;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,.12)}
  .mg-canvas{display:block;width:100%;height:340px;background:linear-gradient(180deg,#0a0e24,#060814)}
  .tip{font-size:12px;color:#b7c3ff;margin-top:8px}

  /* Gate */
  .hidden{display:none}
  .gate{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:2000}
  .gate.show{display:grid}
  .modalCard h3{margin:0 0 10px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
  .btnPrimary{background:#ffd86a;color:#361e00;box-shadow:0 4px 0 rgba(0,0,0,.12)}
  .inp{width:100%;border-radius:10px;border:1px solid var(--edge);background:#0f1030;color:#eff3ff;padding:10px 12px}
  .dim{font-size:12px;color:#aeb9ff}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="hrow">
        <div class="title" id="hdrTitle">Referral Race</div>
        <div class="muted" style="font-size:12px">v1 • live</div>
      </div>
    </header>
    <main id="view"></main>
  </div>

  <!-- Bottom Nav -->
  <nav class="iconnav" aria-label="Primary">
    <div class="inkbar" aria-hidden="true"></div>
    <button class="itab active" data-tab="home" data-idx="0" aria-label="Home">
      <svg class="ico" viewBox="0 0 24 24"><path d="M4 10.5l8-6 8 6V20a2 2 0 0 1-2 2h-3.5a1.5 1.5 0 0 1-1.5-1.5V16a2 2 0 0 0-2-2 2 2 0 0 0-2 2v4.5A1.5 1.5 0 0 1 7.5 22H4a2 2 0 0 1-2-2v-9.5z"/></svg><span>Home</span>
    </button>
    <button class="itab" data-tab="ranks" data-idx="1" aria-label="Ranks">
      <svg class="ico" viewBox="0 0 24 24"><path d="M7 22V11a2 2 0 0 1 2-2h6v13H7zM3 22v-7a2 2 0 0 1 2-2h1v9H3zM17 22V5a2 2 0 0 1 2-2h2v19h-4zM10 5l2-3 2 3"/></svg><span>Ranks</span>
    </button>
    <button class="itab" data-tab="community" data-idx="2" aria-label="Community">
      <svg class="ico" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4 0-8 2-8 5v1h16v-1c0-3-4-5-8-5z"/></svg><span>Community</span>
    </button>
    <button class="itab" data-tab="minigame" data-idx="3" aria-label="Mini Game">
      <svg class="ico" viewBox="0 0 24 24"><path d="M4 8a4 4 0 0 1 4-4h2a2 2 0 0 1 2 2v1h2a2 2 0 0 1 2 2v1h2a2 2 0 0 1 2 2v2h-4l-2 3H8l-2-3H2v-3a3 3 0 0 1 2-3z"/></svg><span>Mini Game</span>
    </button>
  </nav>

  <!-- Video modal -->
  <div id="ytModal" class="modalBackdrop">
    <div class="modalCard">
      <button class="closeX" id="ytClose">✕</button>
      <h3>How to Refer</h3>
      <div class="vidWrap">
        <iframe id="ytFrame" width="560" height="315"
          src="" title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen style="border:0;width:100%;height:100%"></iframe>
      </div>
    </div>
  </div>

  <!-- Login Gate (opens ONLY after Mini Game click if not linked and no token) -->
  <div id="gate" class="gate">
    <div class="modalCard">
      <button id="gateClose" class="closeX" aria-label="Close">✕</button>
      <h3>Login required</h3>
      <p class="dim">Start the Telegram bot and submit your <b>ricobet_username</b>, then press <b>PLAY NOW</b> in the bot.</p>
      <div class="row" style="margin-top:8px">
        <a id="startBot" class="btn btnPrimary" href="https://t.me/ricobet_minigamebot?start=play" target="_blank" rel="noopener">Start the Bot</a>
        <span class="dim">or use the fallback below.</span>
      </div>
      <p class="dim" style="margin:8px 0 4px">After submitting your username in the bot, tap <b>PLAY NOW</b> to return.</p>
      <div class="row" style="margin-top:8px">
        <input id="ricoInput" class="inp" placeholder="ricobet_username"/>
        <button id="btnBind" class="btn btnPrimary">Unlock</button>
      </div>
    </div>
  </div>

  <!-- Theme music -->
  <audio id="bgm" src="theme.mp3" preload="auto" loop playsinline></audio>
  <button id="soundBtn" class="soundBtn" aria-label="Toggle sound" title="Sound">
    <svg viewBox="0 0 24 24" class="ic"><path d="M4 10h4l5-4v12l-5-4H4zM17 8a5 5 0 010 8"/></svg><span>Sound</span>
  </button>

<script>
/* ===== CONFIG ===== */
const GAS_URL = "https://script.google.com/macros/s/AKfycbxo_JlcM5rL9v7quZ_HViaSStZ9L7pAPCZ_E1YUHsIGf7KV8fs4MRo2NBkb4qI7x1i6wA/exec";
const RANK_SHEET_ID = "1rJg4RYn0AkvsqhVGk5CwhZrYNz0gFC6_7ZPiDXigU"; // ranking sheet (gviz)
const RANK_SHEET_GID = "0";

/* ===== tiny helpers ===== */
const $=(s,el)=> (el||document).querySelector(s);
const $all=(s,el)=> Array.from((el||document).querySelectorAll(s));
const fmt=n=>{n=Number(n||0);return n>=1000?(Math.round(n/100)/10).toLocaleString()+"K":n.toLocaleString()};
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const unique=a=>Array.from(new Set(a));
const qs = new URLSearchParams(location.search);
const faceBg=url=> `url("${url}")`;

/* rank avatars mapping (1..20; 20+ uses 20) */
const RANK_AVATARS=[
  "https://ricomx.ft-crm.com/media-api/serve/30739191-4079-40cd-9154-f15c869c9f35_1.png",
  "https://ricomx.ft-crm.com/media-api/serve/7e97b3d5-f53f-4211-b7d3-0c012a8e05ff_2.png",
  "https://ricomx.ft-crm.com/media-api/serve/4120e46c-d810-46bb-924d-fb7769b56c0c_3.png",
  "https://ricomx.ft-crm.com/media-api/serve/84bc31f3-69d6-47e9-950b-e557dd0cf4f6_4.png",
  "https://ricomx.ft-crm.com/media-api/serve/d0692e25-3fdf-4004-af72-b572175fd49c_5.png",
  "https://ricomx.ft-crm.com/media-api/serve/596c02c5-ad1c-42b7-9fb2-da6df154d35b_6.png",
  "https://ricomx.ft-crm.com/media-api/serve/587f1afe-0e39-4f76-8715-48496452cfdf_7.png",
  "https://ricomx.ft-crm.com/media-api/serve/6959ee62-92fa-4192-a2d6-f678a4934b4f_8.png",
  "https://ricomx.ft-crm.com/media-api/serve/a450b16e-9310-4e83-ae66-ea71822a218b_9.png",
  "https://ricomx.ft-crm.com/media-api/serve/24e07c3f-99fb-4bed-91f1-b91f1e0f7c8d_10.png",
  "https://ricomx.ft-crm.com/media-api/serve/120d451f-a6dc-4f7b-b3f4-a1b5b8642443_11.png",
  "https://ricomx.ft-crm.com/media-api/serve/65646abf-45f0-46b4-9c9c-f135f3b429e4_12.png",
  "https://ricomx.ft-crm.com/media-api/serve/685901d2-f392-4d9f-83bf-b8f5ae4cf3bc_13.png",
  "https://ricomx.ft-crm.com/media-api/serve/a3e8f9f5-851f-4048-b1ff-e7255de54266_14.png",
  "https://ricomx.ft-crm.com/media-api/serve/92cde2cb-1afa-4c2e-b0f7-bf77f6b37a4a_15.png",
  "https://ricomx.ft-crm.com/media-api/serve/1a77dbff-a836-4e7b-831f-77734198c725_16.png",
  "https://ricomx.ft-crm.com/media-api/serve/ab17bec9-169e-4e99-9e2d-e560fd29403e_17.png",
  "https://ricomx.ft-crm.com/media-api/serve/a698b757-2f99-49a7-95fb-68318d1637d6_18.png",
  "https://ricomx.ft-crm.com/media-api/serve/ab8c0632-b1d4-41e5-be64-ba1e96d5ab1b_19.png",
  "https://ricomx.ft-crm.com/media-api/serve/7c6d505e-174d-4214-9e93-bb7cdcc4098f_20.png",
];

/* ===== state ===== */
let state={tab:'home'};
let ALL=[],WEEKS=[],CUR_WEEK='',TOP100=[];

/* ===== audio (autoplay with gesture fallback) ===== */
(function(){
  const audio=$('#bgm'), btn=$('#soundBtn'); if(!audio||!btn) return;
  const saved=localStorage.getItem('bgm_pref'); if(saved==='off'){audio.muted=true} if(saved==='on'){audio.muted=false}
  document.addEventListener('DOMContentLoaded',tryPlay,{once:true});
  async function tryPlay(){try{
    if(localStorage.getItem('bgm_pref')==='off'){btn.classList.add('show');return}
    audio.muted=false; await audio.play(); btn.classList.remove('show'); localStorage.setItem('bgm_pref','on')
  }catch(e){
    btn.classList.add('show');
    ['pointerdown','keydown','touchstart'].forEach(evt=>document.addEventListener(evt,unlock,{once:true}))
  }}
  async function unlock(){try{audio.muted=false;await audio.play();btn.classList.remove('show');btn.classList.add('active');localStorage.setItem('bgm_pref','on')}catch{}}
  btn.addEventListener('click',async()=>{try{
    if(audio.paused){audio.muted=false;await audio.play()}
    else {audio.muted=!audio.muted;if(audio.muted)await audio.pause();else await audio.play()}
    const on=!audio.paused && !audio.muted; btn.classList.toggle('active',on); if(on) btn.classList.remove('show'); localStorage.setItem('bgm_pref',on?'on':'off')
  }catch{}})
})();

/* ===== auth helpers ===== */
const isLinked=()=> !!localStorage.getItem('auth_token');

/* ===== gate control ===== */
function openGate(){ $('#gate').classList.add('show'); }
function closeGate(){ $('#gate').classList.remove('show'); }

/* manual fallback unlock -> kind: telegram */
async function manualUnlock(username){
  try{
    const r=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({kind:'telegram',ricobet_username:username,data:{
        id: localStorage.getItem('tg_id')||('guest-'+crypto.randomUUID()),
        username: localStorage.getItem('tg_username')||''
      }})});
    const j=await r.json();
    if(j.ok && j.token){
      localStorage.setItem('auth_token', j.token);
      localStorage.setItem('player_name', j.user?.ricoUsername || j.user?.username || username || 'player');
      closeGate(); state.tab='minigame'; render();
    }else{
      alert('Unlock failed');
    }
  }catch(e){ alert('Unlock failed: '+e.message); }
}

/* ===== nav / router ===== */
function moveInk(ix){ document.querySelector('.iconnav').style.setProperty('--ix', ix); }
function render(){
  $('#hdrTitle').textContent = state.tab==='ranks' ? 'Referral Ranking'
    : state.tab==='community' ? 'Community'
    : state.tab==='minigame' ? 'Mini Game' : 'Referral Race';

  $all('.iconnav .itab').forEach(b=>b.classList.toggle('active',b.dataset.tab===state.tab));
  moveInk(parseInt(document.querySelector('.iconnav .itab.active')?.dataset.idx||'0',10));

  if(state.tab==='ranks') renderRanks();
  else if(state.tab==='community') renderCommunity();
  else if(state.tab==='minigame') renderMiniGame();
  else renderHome();
}

/* ===== views ===== */
function renderHome(){
  $('#view').innerHTML = `
    <div class="card">
      <h2>Referral Race</h2>
      <p>Invite friends, climb the leaderboard, and win rewards.</p>
      <ul style="margin:6px 0 0 18px;color:#dfe5ff">
        <li>Share your referral link with friends.</li>
        <li>Every verified signup = <b>+1 point</b>.</li>
        <li><b>Weekly</b> leaderboard resets every Monday.</li>
      </ul>
    </div>

    <div class="card qa">
      <h3>Quick Actions</h3>
      <div class="row">
        <div>Refer Friends</div>
        <a class="btn" href="https://www.rico.bet/myreferral" target="_blank" rel="noopener">Open</a>
      </div>
      <div class="row">
        <div>Watch My Leaderboard</div>
        <button class="btn" id="ctaRanks">Open</button>
      </div>
      <div class="row">
        <div>Watch how to refer</div>
        <button class="btn" id="ctaHow">Open</button>
      </div>
    </div>

    <div class="card">
      <details>
        <summary>Terms & Conditions</summary>
        <p>By joining the Referral Race, you agree to the rules below.</p>
        <details open><summary>How do I earn points?</summary><p>Each verified signup via your link grants <b>+1 point</b>. Bonus events may add extra points.</p></details>
        <details><summary>When are winners announced?</summary><p>Weekly winners every Monday.</p></details>
        <details><summary>How do payouts work?</summary><p>Rewards are credited within 72 hours after announcement.</p></details>
        <details><summary>Anti-fraud</summary><p>Duplicate or fake signups will be removed; repeated abuse may lead to disqualification.</p></details>
      </details>
    </div>
  `;
  $('#ctaRanks').onclick=()=>{$('.iconnav .itab[data-tab="ranks"]').click()};
  $('#ctaHow').onclick=()=>openYT();
}

/* YouTube modal */
function openYT(){
  $('#ytFrame').src="https://www.youtube.com/embed/A6DljwDp12A?autoplay=1&rel=0";
  $('#ytModal').classList.add('show');
}
$('#ytClose').onclick=()=>{$('#ytModal').classList.remove('show'); $('#ytFrame').src=""}

/* Leaderboard */
async function fetchGViz(){
  const url=`https://docs.google.com/spreadsheets/d/${RANK_SHEET_ID}/gviz/tq?tqx=out:json&gid=${encodeURIComponent(RANK_SHEET_GID)}`;
  const text=await fetch(url,{cache:"no-store"}).then(r=>r.text());
  const j=(text.match(/google\.visualization\.Query\.setResponse\((.*)\);?/s)||[])[1]; if(!j) throw new Error('parse');
  const data=JSON.parse(j);
  const headers=data.table.cols.map(c=>c.label||c.id||"");
  const rows=data.table.rows.filter(r=>r&&r.c).map(r=> r.c.map(c=> c?(c.f!=null?c.f:c.v):""));
  return {headers,rows};
}
function pickIndex(headers,aliases){const L=headers.map(h=>String(h||'').toLowerCase());for(const a of aliases){const j=L.findIndex(h=>h.includes(a));if(j>-1)return j}return -1}
function normalize({headers:h,rows}){
  const ui=pickIndex(h,["username","user","player","name"]);
  const pi=pickIndex(h,["points","score","total","referrals"]);
  const wi=pickIndex(h,["week","period"]);
  const di=pickIndex(h,["date","day","created","timestamp"]);
  if(ui<0||pi<0||wi<0) throw new Error('missing cols');
  return rows.map(r=>({username:String(r[ui]||"").trim(),points:Number(String(r[pi]).replace(/[^\d.\-]/g,''))||0,week:String(r[wi]||"").trim(),date: di>-1? String(r[di]||"").trim() : ""})).filter(x=>x.username);
}
const maskName = s => {
  s=String(s||'');
  if(s.length<=2) return s.replace(/.(?=.)/g,'*');
  const a=s[0], b=s[s.length-1];
  const middle = s.slice(1,-1).replace(/./g,'*');
  return a+middle+b;
};
function renderRanks(){
  $('#view').innerHTML=`
    <div class="rr">
      <div class="card">
        <div class="controls">
          <select id="weekSel" class="select" title="Week"></select>
          <select id="daySel" class="select" title="Day (inside week)"></select>
          <button id="prevBtn" class="wbtn" type="button">◀</button>
          <button id="nextBtn" class="wbtn" type="button">▶</button>
        </div>
      </div>
      <div class="podiumCard">
        <div class="podium">
          <div class="step s2"><div class="trophy t2">2</div><div class="av" id="rr-p2a"></div><div class="name" id="rr-p2n">—</div><div class="scoreMini" id="rr-p2s"></div></div>
          <div class="step s1"><div class="trophy t1">1</div><div class="av" id="rr-p1a"></div><div class="name" id="rr-p1n">—</div><div class="scoreMini" id="rr-p1s"></div></div>
          <div class="step s3"><div class="trophy t3">3</div><div class="av" id="rr-p3a"></div><div class="name" id="rr-p3n">—</div><div class="scoreMini" id="rr-p3s"></div></div>
        </div>
      </div>
      <div class="list" id="rr-list"></div>
      <div class="search"><input id="rr-q" class="input" placeholder="Search username (top 100)…"/><button id="rr-find" class="go">Find</button></div>
      <div id="rr-mine" class="result"></div>
    </div>`;
  if(!ALL.length){
    fetchGViz().then(normalize).then(items=>ALL=items).catch(()=> {
      ALL=[{week:'Week 1',username:'alice',points:3000},{week:'Week 1',username:'bob',points:2500},{week:'Week 1',username:'ricobet',points:1000}];
    }).finally(()=>{buildWeeks();fillWeekUI();});
  }else{buildWeeks();fillWeekUI();}

  function buildWeeks(){const weeks=unique(ALL.map(x=>x.week).filter(Boolean)).sort((a,b)=>{const na=(a.match(/\d+/)||[])[0], nb=(b.match(/\d+/)||[])[0];return (na&&nb)?na-nb:a.localeCompare(b)});WEEKS=weeks;CUR_WEEK=WEEKS[WEEKS.length-1]||''}
  function fillDayUI(){const daySel=$('#daySel');daySel.innerHTML='';const days=unique(ALL.filter(x=>x.week===CUR_WEEK).map(x=>x.date||'').filter(Boolean)).sort();daySel.insertAdjacentHTML('beforeend','<option value="">All week</option>');days.forEach(d=>daySel.insertAdjacentHTML('beforeend',`<option>${d}</option>`));daySel.value=''}
  function fillWeekUI(){const sel=$('#weekSel');sel.innerHTML='';WEEKS.forEach(w=>sel.insertAdjacentHTML('beforeend',`<option>${w}</option>`));sel.value=CUR_WEEK;fillDayUI();renderWeek();
    $('#rr-find').onclick=findUser; $('#rr-q').addEventListener('keydown',e=>{if(e.key==='Enter')findUser()});
    $('#weekSel').onchange=function(){CUR_WEEK=this.value;fillDayUI();renderWeek()}; $('#daySel').onchange=function(){renderWeek()};
    $('#prevBtn').onclick=function(){const d=$('#daySel');if(d.value){const opts=[...d.options].map(o=>o.value).filter(Boolean);const i=opts.indexOf(d.value);d.value=i>0?opts[i-1]:'';renderWeek();return}
      const i=WEEKS.indexOf(CUR_WEEK);if(i>0){CUR_WEEK=WEEKS[i-1];sel.value=CUR_WEEK;fillDayUI();renderWeek()}};
    $('#nextBtn').onclick=function(){const d=$('#daySel');if(d.value){const opts=[...d.options].map(o=>o.value).filter(Boolean);const i=opts.indexOf(d.value);d.value=(i>-1&&i<opts.length-1)?opts[i+1]:'';renderWeek();return}
      const i=WEEKS.indexOf(CUR_WEEK);if(i<WEEKS.length-1){CUR_WEEK=WEEKS[i+1];sel.value=CUR_WEEK;fillDayUI();renderWeek()}}
  }
  function filterWeekDay(week,day){let arr=ALL.filter(x=>x.week===week);if(day)arr=arr.filter(x=>(x.date||'')===day);arr=arr.sort((a,b)=>b.points-a.points);arr.forEach((x,i)=>x.rank=i+1);return arr}
  function rankAvatar(r){const i=Math.min(Math.max(1,r),20)-1;return RANK_AVATARS[i]}

  function renderWeek(){
    const day=$('#daySel')?.value||'';const items=filterWeekDay(CUR_WEEK,day);
    const setPod=(id,row)=>{ const url=row?rankAvatar(row.rank):RANK_AVATARS[0];
      $(`#rr-p${id}a`).style.backgroundImage=faceBg(url);
      $(`#rr-p${id}n`).textContent=row?maskName(row.username):'—';
      $(`#rr-p${id}s`).textContent=row?(fmt(row.points)+' pts'):'' }
    setPod(1,items[0]||null);setPod(2,items[1]||null);setPod(3,items[2]||null);

    const list=$('#rr-list');list.innerHTML='';
    items.slice(3,15).forEach(r=>list.insertAdjacentHTML('beforeend',
      `<div class="row">
        <div class="rk">${r.rank}</div>
        <div class="left">
          <div class="face" style="background-image:${faceBg(rankAvatar(r.rank))}"></div>
          <div class="uname">${esc(maskName(r.username))}</div>
        </div>
        <div class="val">${fmt(r.points)}</div>
      </div>`));
    TOP100=items.slice(0,100);
  }
  function findUser(){const q=($('#rr-q').value||'').trim().toLowerCase();const res=$('#rr-mine');if(!q){res.style.display='block';res.textContent='Enter a username';return}
    const hit=TOP100.find(x=>x.username.toLowerCase()===q);res.style.display='block';if(!hit){res.textContent='No match in Top 100 for current selection.';return}
    const day=$('#daySel').value;const scope=day?day:(CUR_WEEK||'this week');res.innerHTML=`<b>${esc(hit.username)}</b> — Rank <b>${hit.rank}</b> • ${fmt(hit.points)} pts • ${esc(scope)}`}
}

/* Community (previous style + share row) */
function renderCommunity(){
  const referUrl = location.href;
  $('#view').innerHTML = `
    <div class="card comm">
      <h2>Share & Follow</h2>
      <p>Invite friends and follow us.</p>
      <div class="sharebar">
        <a class="sharebtn" target="_blank" rel="noopener"
           href="https://t.me/share/url?url=${encodeURIComponent(referUrl)}">Share on Telegram</a>
        <a class="sharebtn" target="_blank" rel="noopener"
           href="https://api.whatsapp.com/send?text=${encodeURIComponent('Join me: '+referUrl)}">Share on WhatsApp</a>
      </div>
    </div>
    <div class="comm">
      <div class="list">
        ${[
          ['Facebook','https://facebook.com/','https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/facebook.svg'],
          ['Instagram','https://instagram.com/','https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg'],
          ['Telegram','https://t.me/','https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/telegram.svg'],
          ['X','https://x.com/','https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/x.svg'],
          ['YouTube','https://youtube.com/','https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg'],
        ].map(([label,href,icon])=>`
          <div class="item">
            <div class="left">
              <div class="bubble"><img alt="" width="26" height="26" src="${icon}"/></div>
              <div style="font-weight:900">${label}</div>
            </div>
            <a class="sub" href="${href}" target="_blank" rel="noopener">Subscribe</a>
          </div>`).join('')}
      </div>
    </div>
  `;
}

/* report score → GAS (robust) */
async function reportScore({game,points,week=""}){
  const token=localStorage.getItem('auth_token')||'';
  if(!token){ console.warn('[score] missing token'); return; }
  try{
    const r=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({kind:'score',token,game,points,week})});
    const j=await r.json().catch(()=> ({}));
    if(!j.ok){ console.warn('[score] rejected', j); }
  }catch(e){ console.warn('[score] network error', e); }
}

/* Mini games */
function renderMiniGame(){
  if(!isLinked()){
    openGate();
    $('#view').innerHTML=`<div class="card"><h2>Mini Game</h2><p class="dim">Tap the Mini Game tab again to open login.</p></div>`;
    return;
  }

  const who=esc(localStorage.getItem('player_name')||'Linked');
  $('#view').innerHTML=`
    <div class="card"><h2>Mini Game</h2><p class="dim">Linked as <b>${who}</b>. Scores will be sent to Google Sheets.</p></div>
    <div class="card">
      <div class="mg-tabs">
        <button class="mg-t active" data-game="flappy">Flappy Spin</button>
        <button class="mg-t" data-game="plinko">Lucky Drop</button>
        <button class="mg-t" data-game="jump">Jump to Win</button>
      </div>
      <div class="mg-wrap">
        <div class="mg-head">
          <div class="title" id="mgTitle">Flappy Spin</div>
          <div class="ctrls"><button class="mg-btn" id="mgStart">Start</button><button class="mg-btn" id="mgStop">Stop</button></div>
        </div>
        <canvas id="mgCanvas" class="mg-canvas" width="480" height="340"></canvas>
      </div>
      <div class="tip" id="mgTip">Tap / Space to flap. Don’t hit the chips!</div>
    </div>`;

  const canvas=$('#mgCanvas'), ctx=canvas.getContext('2d');
  const title=$('#mgTitle'), tip=$('#mgTip');
  let game='flappy', RAF=null, cleanup=null;
  function setCanvasSize(){const w=canvas.clientWidth; canvas.width=Math.round(w); canvas.height=340}
  setCanvasSize(); addEventListener('resize',setCanvasSize);
  $all('.mg-t').forEach(b=>b.onclick=()=>{$all('.mg-t').forEach(x=>x.classList.remove('active'));b.classList.add('active');game=b.dataset.game;stopGame();
    if(game==='flappy'){title.textContent='Flappy Spin';tip.textContent='Tap / Space to flap. Don’t hit the chips!'}
    if(game==='plinko'){title.textContent='Lucky Drop';tip.textContent='Tap / Click to drop a ball. Watch it bounce!'}
    if(game==='jump'){title.textContent='Jump to Win';tip.textContent='Collect coins. Tilt/Arrows to move.'}});
  $('#mgStart').onclick=()=>startGame(); $('#mgStop').onclick=()=>stopGame();
  function startGame(){stopGame(); cleanup=(game==='flappy')?runFlappy():(game==='plinko')?runPlinko():runJump()}
  function stopGame(){if(RAF)cancelAnimationFrame(RAF); if(cleanup){try{cleanup()}catch{} cleanup=null}
    ctx.clearRect(0,0,canvas.width,canvas.height); ctx.fillStyle='#0a0f22'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='#fff'; ctx.font='bold 16px Inter'; ctx.textAlign='center'; ctx.fillText('Press Start', canvas.width/2, canvas.height/2)}

  function runFlappy(){const w=canvas.width,h=canvas.height;let bird={x:w*0.28,y:h*0.45,r:12,vy:0},pipes=[],gap=110,t=0,gravity=0.45,jump=-6.5,alive=true,score=0;
    function spawn(){const top=40+Math.random()*(h-gap-80);pipes.push({x:w+20,top,bot:top+gap,w:38,scored:false})}
    function flap(){if(!alive)return; bird.vy=jump} canvas.onclick=flap; const keyH=e=>{if(e.code==='Space')flap()}; window.addEventListener('keydown',keyH);
    function chip(x,y,r){ctx.save();ctx.translate(x,y);ctx.rotate(((t+x)*0.01)%Math.PI*2);ctx.fillStyle='#ffd86a';ctx.beginPath();ctx.arc(0,0,r,0,Math.PI*2);ctx.fill();ctx.fillStyle='#5a3b00';ctx.font='bold 12px Inter';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('¢',0,0);ctx.restore()}
    function loop(){RAF=requestAnimationFrame(loop);t++;ctx.clearRect(0,0,w,h);ctx.fillStyle='#081025';ctx.fillRect(0,0,w,h);
      if(t%90===0)spawn(); for(let i=pipes.length-1;i>=0;i--){const p=pipes[i];p.x-=2.2;ctx.fillStyle='#1b2b66';ctx.fillRect(p.x,0,p.w,p.top);ctx.fillRect(p.x,p.bot,p.w,h-p.bot);chip(p.x+p.w/2,p.top-18,10);chip(p.x+p.w/2,p.bot+18,10);
        if(!p.scored && p.x+p.w<bird.x){p.scored=true;score++} if(p.x+p.w<0)pipes.splice(i,1); if(bird.x>p.x-bird.r && bird.x<p.x+p.w+bird.r){if(bird.y-bird.r<p.top||bird.y+bird.r>p.bot)alive=false}}
      bird.vy+=gravity;bird.y+=bird.vy;ctx.fillStyle='#7fe3ff';ctx.beginPath();ctx.arc(bird.x,bird.y,bird.r,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#ffd86a';ctx.fillRect(bird.x-10,bird.y-bird.r-10,20,6);ctx.fillStyle='#fff';ctx.font='bold 16px Inter';ctx.textAlign='start';ctx.fillText('Score: '+score,12,24);
      if(bird.y>h-10||bird.y<10)alive=false; if(!alive){ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(0,0,w,h);ctx.fillStyle='#fff';ctx.font='bold 20px Inter';ctx.textAlign='center';ctx.fillText('Game Over • '+score+' pts',w/2,h/2);reportScore({game:'flappy',points:score,week:CUR_WEEK||''});cancelAnimationFrame(RAF)}}
    loop(); return ()=>{canvas.onclick=null;window.removeEventListener('keydown',keyH)}}

  function runPlinko(){const w=canvas.width,h=canvas.height;const pins=[],cols=9,rows=7,spacing=w/(cols+1),offsetY=70;
    for(let r=0;r<rows;r++){for(let c=0;c<cols;c++){const x=spacing*(c+1)+(r%2?spacing/2:0),y=offsetY+r*38;if(x>20&&x<w-20)pins.push({x,y})}}
    const slotVals=[5,10,20,50,20,10,5,15,25]; let ball=null,lastAward=0; function drop(x){if(ball)return;ball={x:x||w/2,y:30,vx:0,vy:0,r:8};lastAward=0}
    canvas.onclick=e=>{const rect=canvas.getBoundingClientRect();drop(e.clientX-rect.left)};
    function drawSlots(){for(let s=0;s<cols;s++){const sx=spacing*(s+1);ctx.fillStyle='#11245a';ctx.fillRect(sx-2,h-60,4,60);ctx.fillStyle='#bcd2ff';ctx.font='bold 12px Inter';ctx.textAlign='center';ctx.fillText(slotVals[s],sx,h-66)}}
    function loop(){RAF=requestAnimationFrame(loop);ctx.clearRect(0,0,w,h);ctx.fillStyle='#060b1a';ctx.fillRect(0,0,w,h);drawSlots();
      ctx.fillStyle='#8aa3ff';pins.forEach(p=>{ctx.beginPath();ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill()});
      if(ball){ball.vy+=0.35;ball.x+=ball.vx;ball.y+=ball.vy;if(ball.x<ball.r){ball.x=ball.r;ball.vx*=-0.6} if(ball.x>w-ball.r){ball.x=w-ball.r;ball.vx*=-0.6}
        pins.forEach(p=>{const dx=ball.x-p.x,dy=ball.y-p.y,d=Math.hypot(dx,dy);if(d<ball.r+5){const ang=Math.atan2(dy,dx),speed=Math.hypot(ball.vx,ball.vy)*0.9+1,dir=(Math.random()<0.5?-1:1)*0.9;ball.vx=Math.cos(ang)*speed*dir;ball.vy=Math.sin(ang)*speed;const ov=ball.r+5-d;ball.x+=Math.cos(ang)*ov;ball.y+=Math.sin(ang)*ov}});
        if(ball.y>h-12){ball.vy*=-0.35;ball.y=h-12;ball.vx*=0.95;if(Math.abs(ball.vy)<0.5){let idx=Math.max(0,Math.min(cols-1,Math.round(ball.x/spacing)-1));lastAward=slotVals[idx]||0;ctx.fillStyle='#fff';ctx.font='bold 18px Inter';ctx.textAlign='center';ctx.fillText('+'+lastAward+' pts',w/2,h/2);reportScore({game:'plinko',points:lastAward,week:CUR_WEEK||''});ball=null}}
        ctx.fillStyle='#ffd86a';ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);ctx.fill()}
      else{const x=(Date.now()/8)%w;ctx.fillStyle='#fff8';ctx.fillRect(x,30,2,20);if(lastAward){ctx.fillStyle='#fff';ctx.font='bold 16px Inter';ctx.textAlign='center';ctx.fillText('Last: +'+lastAward,w/2,28)}}}
    loop(); return ()=>{canvas.onclick=null}}

  function runJump(){const w=canvas.width,h=canvas.height;let player={x:w/2,y:h-40,vx:0,vy:-8,r:12},plats=[],count=12,ax=0,score=0,coins=[];
    for(let i=0;i<count;i++)plats.push({x:Math.random()*(w-80)+40,y:i*(h/count)});
    function spawnCoin(y){coins.push({x:Math.random()*(w-60)+30,y, r:6,t:0,taken:false})}
    plats.forEach(p=>spawnCoin(p.y-30));
    function onKey(e,d){if(e.code==='ArrowLeft')ax=d?-0.4:0;if(e.code==='ArrowRight')ax=d?0.4:0} const kd=e=>onKey(e,true), ku=e=>onKey(e,false); window.addEventListener('keydown',kd);window.addEventListener('keyup',ku);
    if(window.DeviceMotionEvent)window.addEventListener('deviceorientation',e=>{if(e.gamma!=null)ax=Math.max(-0.5,Math.min(0.5,e.gamma/50))});
    function loop(){RAF=requestAnimationFrame(loop);ctx.clearRect(0,0,w,h);ctx.fillStyle='#050a18';ctx.fillRect(0,0,w,h);
      player.vx+=ax;player.vx*=0.98;player.x+=player.vx;player.vy+=0.25;player.y+=player.vy;
      if(player.x<player.r){player.x=player.r;player.vx*=-0.6} if(player.x>w-player.r){player.x=w-player.r;player.vx*=-0.6}
      if(player.y<h*0.4){const dy=(h*0.4-player.y);player.y+=dy;plats.forEach(p=>p.y+=dy);coins.forEach(c=>c.y+=dy)}
      plats.forEach(p=>{ctx.fillStyle='#273a8c';ctx.fillRect(p.x-30,p.y,60,8);if(player.vy>0&&player.y+player.r<p.y+8&&player.y+player.r>p.y&&Math.abs(player.x-p.x)<34){player.vy=-7.8}})
      coins.forEach((c,i)=>{c.t+=0.1;ctx.save();ctx.translate(c.x,c.y);ctx.rotate(c.t);ctx.fillStyle='#ffd86a';ctx.beginPath();ctx.arc(0,0,c.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='#5a3b00';ctx.font='bold 10px Inter';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('¢',0,0);ctx.restore();
        const dx=player.x-c.x,dy=player.y-c.y;if(Math.hypot(dx,dy)<player.r+c.r){score++;coins.splice(i,1)}})
      if(coins.length<6){spawnCoin(-20)}
      ctx.fillStyle='#7fe3ff';ctx.beginPath();ctx.arc(player.x,player.y,player.r,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ffd86a';ctx.fillRect(player.x-10,player.y-player.r-10,20,6);
      ctx.fillStyle='#fff';ctx.font='bold 16px Inter';ctx.textAlign='start';ctx.fillText('Coins: '+score,12,24);
      if(player.y>h+80){ctx.fillStyle='rgba(0,0,0,.45)';ctx.fillRect(0,0,w,h);ctx.fillStyle='#fff';ctx.font='bold 20px Inter';ctx.textAlign='center';ctx.fillText('You fell! • '+score+' pts',w/2,h/2);reportScore({game:'jump',points:score,week:CUR_WEEK||''});cancelAnimationFrame(RAF)}}
    loop(); return ()=>{window.removeEventListener('keydown',kd);window.removeEventListener('keyup',ku)}}

  stopGame();
}

/* bottom nav + gate behavior */
$all('.iconnav .itab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const tab=btn.getAttribute('data-tab');
    state.tab=tab;
    if(tab==='minigame'){ if(!isLinked()) openGate(); } else { closeGate(); }
    render();
  });
});

/* gate buttons */
document.addEventListener('click',e=>{
  if(e.target.id==='gateClose') closeGate();
  if(e.target.id==='btnBind'){
    const v=($('#ricoInput').value||'').trim();
    if(!v){ alert('Please enter ricobet_username'); return; }
    manualUnlock(v);
  }
});

/* Handle deep-link return: ?token=... (SendPulse PLAY NOW) */
(async function bootAuthFromToken(){
  const token = qs.get('token');
  if(token){
    localStorage.setItem('auth_token', token);
    try{
      const r = await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({kind:'whoami',token})});
      const j = await r.json();
      if(j.ok && j.user){
        localStorage.setItem('player_provider','telegram');
        localStorage.setItem('player_provider_id', String(j.user.telegram_id||''));
        localStorage.setItem('player_name', j.user.rico_username || j.user.telegram_username || 'player');
        localStorage.setItem('tg_id', String(j.user.telegram_id||''));
        localStorage.setItem('tg_username', j.user.telegram_username||'');
      }
    }catch(e){/* silent */}
    state.tab='minigame';
  }
})();

/* boot UI */
render(); moveInk(0);
</script>
</body>
</html>
